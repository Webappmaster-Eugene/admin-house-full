#3 —à–∞–≥
#–ë–µ—Ä–µ–º –º–∞—à–∏–Ω—É GitHub, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å VDS –ø–æ ssh, –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –¥–æ–∫–µ—Ä—Ö–∞–±–∞, –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å GitHub –∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å–µ –Ω–∞—à–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–≤ —Ç–æ–º —á–∏—Å–ª–µ —Ñ—Ä–æ–Ω—Ç –∏ –±—ç–∫, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ª–µ–∂–∞—Ç –Ω–∞ –¥–æ–∫–µ—Ä—Ö–∞–±–µ –±–ª–∞–≥–æ–¥–∞—Ä—è 2 —à–∞–≥—É - build.yml)
#deploy to prod

name: Deploy
on:
  workflow_run:
    workflows: ["Build"]
    branches: [main]
    types:
      - completed
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: install ssh keys
        run: |
          install -m 600 -D /dev/null ~/.ssh/id_rsa
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} > ~/.ssh/known_hosts
      - name: connect, pull and restart container
        run: ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ${{ secrets.WORK_DIR }} && git checkout main && git pull && docker pull ${{ secrets.DOCKERHUB_USERNAME }}/admin-house-front:latest && docker pull ${{ secrets.DOCKERHUB_USERNAME }}/admin-house-back:latest && docker compose up -d --no-deps --force-recreate && exit"
      - name: generate, push structure and seed with prisma in PostgreSQL DB
        run: ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ${{ secrets.WORK_DIR }} && docker exec -it eugenenumart/admin-house-back:latest 'npx prisma generate && npx prisma db push && npx prisma db seed' && exit"
      - name: cleanup
        run: rm -rf ~/.ssh

  send-start-deploy-telegram-message:
    name: Send Telegram message
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v2
      - name: Send Telegram message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üèπ Deploy ${{ github.repository }} Deployment has started
            commit message: ${{ github.event.name }}
            author: ${{ github.actor }}
            commit timestamp: ${{ github.event.commits[0] }}
            See changes: https://github.com/${{ github.repository }}/commit/${{github.sha}}

  send-telegram-message:
    name: Send Telegram message
    needs: [ deploy ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v2
      - name: Send Telegram message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚úÖ ${{ github.REPOSITORY }} Build, Deployed Successfully
            image tag: *${{ github.sha }}*
            commit message: ${{ commit.ref }}
            author: ${{ github.actor }}
            commit timestamp: ${{ github.ref }}
            See changes: https://github.com/${{ github.repository }}/commit/${{github.sha}}
            

  notify-on-error:
    runs-on: ubuntu-latest
    needs: [ deploy ]
    if: failure()
    steps:
      - name: Checkout source code
        uses: actions/checkout@v2
      - name: Send error notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚ùå ${{ github.REPOSITORY }} One of the jobs has fail - ${{github.action}}
            See commit: https://github.com/${{ github.repository }}/commit/${{github.sha}}
