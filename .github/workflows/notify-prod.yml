name: Notify about deploy to prod
on: push

jobs:
    send-start-deploy-telegram-message:
      name: Send Telegram message
      runs-on: ubuntu-latest
      steps:
        - name: Checkout source code
          uses: actions/checkout@v2

        - name: Send Telegram message
          uses: appleboy/telegram-action@master
          with:
            to: ${{ secrets.TELEGRAM_CHAT_ID }}
            token: ${{ secrets.TELEGRAM_TOKEN }}
            message: |
              üèπ Deploy ${{ github.REPOSITORY }} Deployment has started
              commit message: ${{ github.event.head_commit.message }}
              author: ${{ github.event.head_commit.author.name }}
              commit timestamp: ${{ github.event.head_commit.timestamp }}

    send-telegram-message:
      name: Send Telegram message
      needs: [ "Build" ]
      runs-on: ubuntu-latest
      steps:
        - name: Checkout source code
          uses: actions/checkout@v2

        - name: Send Telegram message
          uses: appleboy/telegram-action@master
          with:
            to: ${{ secrets.TELEGRAM_CHAT_ID }}
            token: ${{ secrets.TELEGRAM_TOKEN }}
            message: |
              ‚úÖ ${{ github.REPOSITORY }} Build, Deployed Successfully
              image tag: *${{ github.sha }}*
              commit message: ${{ github.event.head_commit.message }}
              author: ${{ github.event.head_commit.author.name }}
              commit timestamp: ${{ github.event.head_commit.timestamp }}

    notify-on-error:
      runs-on: ubuntu-latest
      needs: [ "Build", "Deploy" ]
      if: failure()
      steps:
        - name: Checkout source code
          uses: actions/checkout@v2

        - name: Send error notification
          uses: appleboy/telegram-action@master
          with:
            to: ${{ secrets.TELEGRAM_CHAT_ID }}
            token: ${{ secrets.TELEGRAM_TOKEN }}
            message: |
              ‚ùå ${{ github.REPOSITORY }} One of the jobs has fail
